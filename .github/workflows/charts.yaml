name: Charts CI/CD Pipeline
on:
  workflow_dispatch:
  repository_dispatch:
    types: [charts-deployment-trigger]

env:
  REPOS: "app-1 app-2 app-3"
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  VERSION: ${{ github.event.client_payload.version }}
  ENVIRONMENT: ${{ github.event.client_payload.environment }}
  REGISTRY: ${{ github.event.client_payload.environment }}containerregistry5th7aytwop.azurecr.io
  AZURE_AKS_CLUSTER: ${{ github.event.client_payload.environment }}-aks-cluster

jobs:
  lint-plan-charts:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0
      
      - name: Configure kubectl
        uses: azure/setup-kubectl@v3
        with:
            version: 'latest'
          
      - name: Lint Helm charts
        run: |
          for chart in charts/*; do
            helm lint "$chart"
          done

      - name: Install helm diff plugin
        run: |
            helm plugin install https://github.com/databus23/helm-diff --version v3.9.4
            helm diff version

      - name: Azure login
        uses: azure/login@v2
        with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set kubeconfig
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_AKS_CLUSTER }} \
            --admin \
            --overwrite-existing

      - name: Verify kubectl connection
        run: |
          kubectl get nodes

      - name: Helm diff check
        run: |
            mkdir -p helm-diffs
            echo "# Helm Deployment Changes for ${{ env.ENVIRONMENT }}" > helm-diffs/summary.md
            echo "" >> helm-diffs/summary.md
            echo "**Version:** ${{ env.VERSION }}" >> helm-diffs/summary.md
            echo "**Environment:** ${{ env.ENVIRONMENT }}" >> helm-diffs/summary.md
            echo "**Registry:** ${{ env.REGISTRY }}" >> helm-diffs/summary.md
            echo "" >> helm-diffs/summary.md
            echo "---" >> helm-diffs/summary.md
            echo "" >> helm-diffs/summary.md

            for i in ${{ env.REPOS }}; do
              echo "‚è≥Checking helm diff for $i"
              
              echo "## Chart: $i" >> helm-diffs/summary.md
              echo "" >> helm-diffs/summary.md

              # Check if release exists
              if helm status $i -n ${{ env.ENVIRONMENT }} &> /dev/null; then
                echo "Release $i exists, checking diff..."
                echo "**Status:** Upgrade existing release" >> helm-diffs/summary.md
                echo "" >> helm-diffs/summary.md
                echo "\`\`\`diff" >> helm-diffs/summary.md
                
                helm diff upgrade $i ./charts/$i \
                  -n ${{ env.ENVIRONMENT }} \
                  --set image.tag=${{ env.VERSION }} \
                  --set image.repository=${{ env.REGISTRY }}/$i \
                  -f charts/$i/values.yaml | tee -a helm-diffs/summary.md
                
                echo "\`\`\`" >> helm-diffs/summary.md
                echo "‚úÖ Diff check completed for $i"
              else
                echo "**Status:** New installation (release does not exist yet)" >> helm-diffs/summary.md
                echo "" >> helm-diffs/summary.md
                echo "\`\`\`" >> helm-diffs/summary.md
                echo "This is a new installation - all resources will be created." >> helm-diffs/summary.md
                echo "\`\`\`" >> helm-diffs/summary.md
                echo "‚ùå Release $i does not exist yet, will be created"
              fi
              
              echo "" >> helm-diffs/summary.md
              echo "---" >> helm-diffs/summary.md
              echo "" >> helm-diffs/summary.md
            done

      - name: Upload helm diff artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-diff-${{ env.ENVIRONMENT }}-${{ env.VERSION }}
          path: helm-diffs/
          retention-days: 30

  manual-approval:
    name: manual approval
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    needs: lint-plan-charts
    steps:
      - name: Download helm diff artifact
        uses: actions/download-artifact@v4
        with:
          name: helm-diff-${{ env.ENVIRONMENT }}-${{ env.VERSION }}
          path: helm-diffs/
      
      - name: Save diff to file for issue
        run: |
          cat > issue-body.md << 'ISSUE_EOF'
          > [!NOTE]
          > Review the Helm diff below, then approve or deny the deployment in **${{ env.ENVIRONMENT }}**.
          
          ISSUE_EOF
          cat helm-diffs/summary.md >> issue-body.md
 
      - name: Await for manual approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.token }}
          approvers: yuriihospodaryshyn
          minimum-approvals: 1
          issue-title: "Manual Approval Required for Helm Chart Deployment - ${{ env.ENVIRONMENT }} - ${{ env.VERSION }}"
          issue-body-file-path: issue-body.md
          exclude-workflow-initiator-as-approver: false

  deploy-charts:
    name: Deploy Helm Charts
    needs: manual-approval
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0
      
      - name: Configure kubectl
        uses: azure/setup-kubectl@v3
        with:
            version: 'latest'

      - name: Install helm diff plugin
        run: |
            helm plugin install https://github.com/databus23/helm-diff --version v3.9.4
            helm diff version

      - name: Azure login
        uses: azure/login@v2
        with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set kubeconfig
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_AKS_CLUSTER }} \
            --admin \
            --overwrite-existing

      - name: Verify kubectl connection
        run: |
          kubectl get nodes

      - name: Deploy the ${{ env.VERSION }} version
        run: |
            for i in ${{ env.REPOS }}; do
              echo "üîÉDeploying $i version ${{ env.VERSION }} to ${{ env.ENVIRONMENT }}"

                if helm upgrade --install $i ./charts/$i \
                  -n ${{ env.ENVIRONMENT }} \
                  --set image.tag=${{ env.VERSION }} \
                  --set image.repository=${{ env.REGISTRY }}/$i \
                  -f charts/$i/values.yaml \
                  --wait --timeout 10m; then
                  echo "‚úÖ Deployed $i successfully"
                else
                  echo "‚ùå Deployment of $i failed"
                  exit 1
                fi
            done

      - name: Check status
        run: |
          for i in ${{ env.REPOS }}; do
            echo "‚è≥Checking helm status for $i..."

            if helm status $i -n ${{ env.ENVIRONMENT }}; then
              echo "‚úÖ $i is deployed"
            else
              echo "‚ùå $i is not deployed, aborting deployment"
              exit 1
            fi
          done