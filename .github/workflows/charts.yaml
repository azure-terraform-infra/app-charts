name: Charts CI/CD Pipeline
on:
  workflow_dispatch:
  repository_dispatch:
    types: [charts-deployment-trigger]
  workflow_call:
    inputs:
      version:
        description: 'Version tag to deploy'
        required: true
        type: string
      environment:
        description: 'Environment to deploy to'
        required: true
        type: string

env:
  REPOS: "app-1 app-2 app-3"
  AZURE_RESOURCE_GROUP: "terraform-infra"

jobs:
  lint-plan-charts:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set envs
        run: |
          echo "VERSION=${{ github.event.client_payload.version || inputs.version }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ github.event.client_payload.environment || inputs.environment }}" >> $GITHUB_ENV
          echo "REGISTRY=${{ env.ENVIRONMENT }}containerregistry5th7aytwop.azurecr.io" >> $GITHUB_ENV
          echo "AZURE_AKS_CLUSTER=${{ env.ENVIRONMENT }}-aks-cluster" >> $GITHUB_ENV

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0
      
      - name: Configure kubectl
        uses: azure/setup-kubectl@v3
        with:
            version: 'latest'
          
      - name: Lint Helm charts
        run: |
          for chart in charts/*; do
            helm lint "$chart"
          done

      - name: Install helm diff plugin
        run: |
            helm plugin install https://github.com/databus23/helm-diff --version v3.9.4
            helm diff version

      - name: Azure login
        uses: azure/login@v2
        with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set kubeconfig
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_AKS_CLUSTER }} \
            --admin \
            --overwrite-existing

      - name: Verify kubectl connection
        run: |
          kubectl get nodes

      - name: Helm diff check
        run: |
            for i in ${{ env.REPOS }}; do
              echo "Checking helm diff for $i"

              # Check if release exists
              if helm status $i -n ${{ env.ENVIRONMENT }} &> /dev/null; then
                echo "Release $i exists, checking diff..."
                helm diff upgrade $i ./charts/$i \
                  -n ${{ env.ENVIRONMENT }} \
                  --set image.tag=${{ env.VERSION }} \
                  --set image.repository=${{ env.REGISTRY }} \
                  -f charts/$i/values.yaml

                echo "✅ Diff check completed for $i"
              else
                echo "❌ Release $i does not exist yet, will be created"
              fi
            done

      - name: Deploy the ${{ env.VERSION }} version
        run: |
            for i in ${{ env.REPOS}}; do
              echo "Deploying $i version ${{ env.VERSION }} to ${{ env.ENVIRONMENT }}"

                if helm upgrade --install $i ./charts/$i \
                  -n ${{ env.ENVIRONMENT }} \
                  --set image.tag=${{ env.VERSION }} \
                  --set image.repository=${{ env.REGISTRY }} \
                  -f charts/$i/values.yaml \
                  --wait --timeout 10m; then
                  echo "✅ Deployed $i successfully"
                else
                  echo "❌ Deployment of $i failed"
                  exit 1
                fi
            done

      - name: Check status
        run: |
          for i in ${{ env.REPOS }}; do
            echo "Checking helm status for $i..."

            if helm status $i -n ${{ env.ENVIRONMENT }}; then
              echo "✅ $i is deployed"
            else
              echo "❌ $i is not deployed, aborting deployment"
              exit 1
            fi
          done